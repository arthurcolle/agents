<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS (shadcn/ui style) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Dynamic Generative UI Agent</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #e1f5fe;
            align-self: flex-end;
            margin-left: auto;
        }
        .agent-message {
            background-color: #f0f0f0;
            align-self: flex-start;
        }
        .input-area {
            display: flex;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0b7dda;
        }
        .dynamic-ui {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }
        .system-goal {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            border-radius: 4px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Dynamic Generative UI Agent</h1>
    
    <div class="system-goal">
        <h3>System Goal:</h3>
        <p id="system-goal-text">Loading system goal...</p>
    </div>
    
    <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
            <div class="message agent-message">
                Hello! I'm Qwen. You can type a message or click the microphone button to speak to me.
            </div>
        </div>
        <div class="input-area">
            <!-- Task selector -->
            <select id="task-select" class="mr-2 border rounded px-2">
                <option value="chat" selected>Chat</option>
                <option value="asr">Speech Recognition</option>
                <option value="translation">Speech Translation</option>
                <option value="classification">Sound Classification</option>
            </select>

            <!-- Voice selector -->
            <select id="voice-select" class="mr-2 border rounded px-2">
                <option value="Chelsie" selected>Chelsie (Default)</option>
                <option value="Ethan">Ethan</option>
            </select>
            <input type="text" id="message-input" class="flex-1 mr-2" placeholder="Type your message here...">
            <input type="file" id="file-input" class="hidden" accept="audio/*,video/*,image/*">
            <button id="mic-button" title="Record audio" class="mr-2">ðŸŽ¤</button>
            <span id="rec-timer" class="text-sm text-gray-500 mr-2 hidden">00:00</span>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div class="dynamic-ui" id="dynamic-ui">
        <h2>Dynamic UI Area</h2>
        <p>This area will update with dynamically generated UI elements based on your conversation.</p>
    </div>
    
    <script>
        const chatMessages   = document.getElementById('chat-messages');
        const messageInput   = document.getElementById('message-input');
        const sendButton     = document.getElementById('send-button');
        const micButton      = document.getElementById('mic-button');
        const recTimer       = document.getElementById('rec-timer');
        const voiceSelect    = document.getElementById('voice-select');
        const taskSelect     = document.getElementById('task-select');
        const fileInput      = document.getElementById('file-input');
        const dynamicUI      = document.getElementById('dynamic-ui');
        const systemGoalText = document.getElementById('system-goal-text');
        
        // Fetch system goal
        fetch('/api/system-goal')
            .then(response => response.json())
            .then(data => {
                systemGoalText.textContent = data.goal;
            });
        
        // WebSocket connection
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        
        ws.onopen = function(e) {
            console.log('WebSocket connection established');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'message') {
                addMessage(data.content, 'agent');
            } else if (data.type === 'ui_update') {
                updateDynamicUI(data.content);
            } else if (data.type === 'thinking') {
                showThinking(data.content);
            }
        };
        
        ws.onclose = function(event) {
            if (event.wasClean) {
                console.log(`Connection closed cleanly, code=${event.code}, reason=${event.reason}`);
            } else {
                console.log('Connection died');
                addMessage('Connection to server lost. Please refresh the page.', 'agent');
            }
        };
        
        ws.onerror = function(error) {
            console.log(`WebSocket error: ${error.message}`);
        };
        
        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                addMessage(message, 'user');
                ws.send(JSON.stringify({
                    type: 'message',
                    content: message
                }));
                messageInput.value = '';
            }
        }
        
        // Add message to chat
        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show thinking indicator
        function showThinking(message) {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message agent-message thinking';
            thinkingDiv.innerHTML = message + ' <span class="loading"></span>';
            thinkingDiv.id = 'thinking-indicator';
            chatMessages.appendChild(thinkingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Update dynamic UI area
        function updateDynamicUI(htmlContent) {
            dynamicUI.innerHTML = htmlContent;
            
            // Execute any scripts in the dynamic UI
            const scripts = dynamicUI.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                Array.from(script.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                });
                newScript.textContent = script.textContent;
                script.parentNode.replaceChild(newScript, script);
            });
        }
        
        /* -------------------- System goal -------------------- */
        fetch('/api/system-goal')
            .then(r => r.json())
            .then(d => systemGoalText.textContent = d.goal)
            .catch(() => {});

        /* -------------------- Conversation ------------------- */
        let conversation = [
            {
                role: "system",
                content: [
                    { type: "text", text: "You are Qwen, a virtual human developed by the Qwen Team, Alibaba Group, capable of perceiving auditory and visual inputs, as well as generating text and speech." }
                ]
            }
        ];

        // Map task â†’ system prompt
        const systemPrompts = {
            chat: "You are Qwen, a virtual human developed by the Qwen Team, Alibaba Group, capable of perceiving auditory and visual inputs, as well as generating text and speech.",
            asr: "You are a speech recognition model.",
            translation: "You are a speech translation model.",
            classification: "You are a vocal sound classification model."
        };

        /* -------------------- Chat helpers ------------------- */
        function addMessage(content, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            div.textContent = content;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /* -------------------- Recording timer ------------------ */
        let timerInterval = null;
        function startTimer() {
            let seconds = 0;
            recTimer.classList.remove('hidden');
            recTimer.textContent = '00:00';
            timerInterval = setInterval(() => {
                seconds += 1;
                const m = String(Math.floor(seconds / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                recTimer.textContent = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() {
            clearInterval(timerInterval);
            recTimer.classList.add('hidden');
            timerInterval = null;
        }

        /* -------------------- Send message ------------------- */
        function sendMessage({text = '', audioBlob = null, imageFile = null} = {}) {
            // Update system prompt based on selected task
            conversation[0].content[0].text = systemPrompts[taskSelect.value] || systemPrompts.chat;
            text = text || messageInput.value.trim();
            if (!text && !audioBlob && !imageFile) return;

            if (text) addMessage(text, 'user');
            messageInput.value = '';

            const form = new FormData();
            if (text) form.append('user_text', text);
            if (audioBlob) form.append('audio', new File([audioBlob], 'recording.webm', {type: 'audio/webm'}));
            if (imageFile) form.append('image', imageFile, imageFile.name);
            form.append('conversation_json', JSON.stringify(conversation));
            form.append('speaker', voiceSelect.value);

            const thinking = document.createElement('div');
            thinking.className = 'message agent-message';
            thinking.innerHTML = 'Thinking <span class="loading"></span>';
            chatMessages.appendChild(thinking);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            fetch('/api/chat', {method: 'POST', body: form})
                .then(r => r.json())
                .then(data => {
                    thinking.remove();
                    if (data.error) {
                        addMessage('Error: ' + data.error, 'agent');
                        console.error(data.details || data.error);
                        return;
                    }
                    conversation = data.conversation;
                    addMessage(data.reply_text, 'agent');
                    if (data.reply_audio_b64) {
                        new Audio('data:audio/wav;base64,' + data.reply_audio_b64).play().catch(() => {});
                    }
                })
                .catch(err => {
                    thinking.remove();
                    addMessage('Error: ' + err.message, 'agent');
                    console.error(err);
                });
        }

        /* -------------------- UI events ---------------------- */
        sendButton.addEventListener('click', () => sendMessage());
        taskSelect.addEventListener('change', () => {
            messageInput.placeholder = taskSelect.value === 'chat'
                ? 'Type your message here...'
                : 'Upload / record audio or type your promptâ€¦';
        });
        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        /* -------------------- Microphone --------------------- */
        let recorder, chunks = [];
        micButton.addEventListener('click', async () => {
            if (recorder && recorder.state === 'recording') {
                recorder.stop();
                micButton.textContent = 'ðŸŽ¤';
                stopTimer();
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                chunks = [];
                recorder = new MediaRecorder(stream);
                recorder.ondataavailable = e => e.data.size && chunks.push(e.data);
                recorder.onstop = () => {
                    stopTimer();
                    const blob = new Blob(chunks, {type: 'audio/webm'});
                    sendMessage({audioBlob: blob});
                    stream.getTracks().forEach(t => t.stop());
                };
                recorder.start();
                micButton.textContent = 'â¹ï¸';
                startTimer();
            } catch (err) {
                console.error(err);
                addMessage('Microphone permission denied.', 'agent');
            }
        });

        /* -------------------- File upload -------------------- */
        fileInput.addEventListener('change', e => {
            const f = e.target.files[0];
            if (f) sendMessage({imageFile: f});
            fileInput.value = '';
        });
    </script>
</body>
</html>
        
